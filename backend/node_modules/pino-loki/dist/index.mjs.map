{"version":3,"file":"index.mjs","names":["current: any","#propsToLabels","#levelMap","value","labels: Record<string, string>","result: Record<string, string>","#buildTimestamp","#buildLabelsFromProps","#buildStructuredMetadata","#stringifyLog","#options","#logBuilder","#handleFailure","batchInterval: NodeJS.Timeout | undefined","pinoLogBuffer: PinoLog[]"],"sources":["../src/debug.ts","../src/constants.ts","../src/get.ts","../src/format_mesage.ts","../src/log_builder.ts","../src/log_pusher.ts","../src/index.ts"],"sourcesContent":["import { debuglog } from 'node:util'\n\nexport default debuglog('pino-loki')\n","/* eslint-disable @typescript-eslint/no-redeclare */\nexport const LokiLogLevel = {\n  Info: 'info',\n  Debug: 'debug',\n  Error: 'error',\n  Warning: 'warning',\n  Critical: 'critical',\n} as const\n\nexport type LokiLogLevel = (typeof LokiLogLevel)[keyof typeof LokiLogLevel]\n","/**\n * Dynamically get a nested value from an array or object with a\n * string.\n */\nexport function get<TDefault = unknown>(\n  value: any,\n  path: string,\n  defaultValue?: TDefault,\n): TDefault {\n  const segments = path.split(/[.[\\]]/g)\n  let current: any = value\n\n  for (const key of segments) {\n    if (current === null) return defaultValue as TDefault\n    if (current === undefined) return defaultValue as TDefault\n\n    const unquotedKey = key.replace(/[\"']/g, '')\n    if (unquotedKey.trim() === '') continue\n\n    current = current[unquotedKey]\n  }\n\n  if (current === undefined) return defaultValue as TDefault\n  return current\n}\n","import { get } from './get.ts'\nimport type { LogFormat, LogFormatExpectedObject } from './types.ts'\n\nexport function formatLog(options: { log: LogFormatExpectedObject; logFormat: LogFormat }): string {\n  const { log, logFormat } = options\n\n  if (logFormat && typeof logFormat === 'string') {\n    return logFormat.replace(/{([^{}]+)}/g, (_match, p1) => get(log, p1) || '')\n  }\n\n  if (logFormat && typeof logFormat === 'function') {\n    return logFormat(options.log)\n  }\n\n  throw new Error('Message format must be a string or a function. Received: ' + typeof logFormat)\n}\n","import { LokiLogLevel } from './constants.ts'\nimport { formatLog } from './format_mesage.ts'\nimport type { LokiLog, PinoLog, LokiOptions, LogFormat, LogFormatExpectedObject } from './types.ts'\n\nconst NANOSECONDS_LENGTH = 19\n\ntype BuilderOptions = Pick<LokiOptions, 'propsToLabels' | 'levelMap'>\n\n/**\n * Converts a Pino log to a Loki log\n */\nexport class LogBuilder {\n  #propsToLabels: string[]\n  #levelMap: { [key: number]: LokiLogLevel }\n\n  constructor(options?: BuilderOptions) {\n    this.#propsToLabels = options?.propsToLabels || []\n    this.#levelMap = Object.assign(\n      {\n        10: LokiLogLevel.Debug,\n        20: LokiLogLevel.Debug,\n        30: LokiLogLevel.Info,\n        40: LokiLogLevel.Warning,\n        50: LokiLogLevel.Error,\n        60: LokiLogLevel.Critical,\n      },\n      options?.levelMap,\n    )\n  }\n\n  /**\n   * Builds a timestamp string from a Pino log object.\n   * @returns A string representing the timestamp in nanoseconds.\n   */\n  #buildTimestamp(log: PinoLog, replaceTimestamp?: boolean): string {\n    if (replaceTimestamp) {\n      return (new Date().getTime() * 1_000_000).toString()\n    }\n\n    const time = log.time || Date.now()\n    const strTime = time.toString()\n\n    // Returns the time if it's already in nanoseconds\n    if (strTime.length === NANOSECONDS_LENGTH) {\n      return strTime\n    }\n\n    // Otherwise, find the missing factor to convert it to nanoseconds\n    const missingFactor = 10 ** (19 - strTime.length)\n    return (time * missingFactor).toString()\n  }\n\n  /**\n   * Stringify the log object. If convertArrays is true then it will convert\n   * arrays to objects with indexes as keys.\n   */\n  #stringifyLog(log: PinoLog, convertArrays?: boolean): string {\n    return JSON.stringify(log, (_, value) => {\n      if (!convertArrays) return value\n\n      if (Array.isArray(value)) {\n        return Object.fromEntries(value.map((value, index) => [index, value]))\n      }\n\n      return value\n    })\n  }\n\n  #buildLabelsFromProps(log: PinoLog) {\n    const labels: Record<string, string> = {}\n\n    for (const prop of this.#propsToLabels) {\n      if (log[prop]) {\n        labels[prop] = log[prop]\n      }\n    }\n\n    return labels\n  }\n\n  /**\n   * Loki structured metadata requires string values only.\n   */\n  #buildStructuredMetadata(\n    log: PinoLog,\n    structuredMetaKey?: string | false,\n  ): Record<string, string> | undefined {\n    if (!structuredMetaKey) return undefined\n\n    const meta = log[structuredMetaKey]\n    if (!meta || typeof meta !== 'object') return undefined\n\n    const result: Record<string, string> = {}\n    for (const [key, value] of Object.entries(meta)) {\n      if (typeof value === 'string') result[key] = value\n      else if (typeof value === 'object' && value !== null) result[key] = JSON.stringify(value)\n      else result[key] = String(value)\n    }\n\n    return result\n  }\n\n  /**\n   * Convert a level to a human readable status\n   */\n  statusFromLevel(level: number) {\n    return this.#levelMap[level] || LokiLogLevel.Info\n  }\n\n  /**\n   * Build a loki log entry from a pino log\n   */\n  build(options: {\n    log: PinoLog\n    replaceTimestamp?: boolean\n    additionalLabels?: Record<string, string>\n    convertArrays?: boolean\n    structuredMetaKey?: string | false\n    logFormat?: LogFormat\n  }): LokiLog {\n    const { hostname, ...logWithoutHostname } = options.log\n\n    const status = this.statusFromLevel(options.log.level)\n    const time = this.#buildTimestamp(options.log, options.replaceTimestamp)\n    const propsLabels = this.#buildLabelsFromProps(options.log)\n    const structuredMetadata = this.#buildStructuredMetadata(options.log, options.structuredMetaKey)\n\n    const formattedMessage = options.logFormat\n      ? formatLog({\n          logFormat: options.logFormat,\n          log: { ...logWithoutHostname, lokilevel: status } as LogFormatExpectedObject,\n        })\n      : this.#stringifyLog(logWithoutHostname, options.convertArrays)\n\n    return {\n      stream: {\n        level: status,\n        hostname,\n        ...options.additionalLabels,\n        ...propsLabels,\n      },\n      values: [\n        // Make sure to exclude structured metadata from the log object\n        // if not present because olders versions of Loki will not accept\n        // it and will return an error.\n        structuredMetadata\n          ? [time, formattedMessage, structuredMetadata]\n          : [time, formattedMessage],\n      ],\n    }\n  }\n}\n","import debug from './debug.ts'\nimport { LogBuilder } from './log_builder.ts'\nimport type { PinoLog, LokiOptions } from './types.ts'\n\nclass RequestError extends Error {\n  responseBody: string\n\n  constructor(message: string, responseBody: string) {\n    super(message)\n    this.name = 'RequestError'\n    this.responseBody = responseBody\n  }\n}\n\n/**\n * Responsible for pushing logs to Loki\n */\nexport class LogPusher {\n  #options: LokiOptions\n  #logBuilder: LogBuilder\n\n  constructor(options: LokiOptions) {\n    this.#options = options\n\n    this.#logBuilder = new LogBuilder({\n      levelMap: options.levelMap,\n      propsToLabels: options.propsToLabels,\n    })\n  }\n\n  /**\n   * Handle push failures\n   */\n  #handleFailure(err: any) {\n    if (this.#options.silenceErrors === true) {\n      return\n    }\n\n    if (err instanceof RequestError) {\n      console.error(err.message + '\\n' + err.responseBody)\n      return\n    }\n\n    console.error('Got unknown error when trying to send log to Loki, error output:', err)\n  }\n\n  /**\n   * Push one or multiples logs entries to Loki\n   */\n  async push(logs: PinoLog[] | PinoLog) {\n    if (!Array.isArray(logs)) {\n      logs = [logs]\n    }\n\n    const lokiLogs = logs.map((log) =>\n      this.#logBuilder.build({\n        log,\n        replaceTimestamp: this.#options.replaceTimestamp,\n        additionalLabels: this.#options.labels,\n        convertArrays: this.#options.convertArrays,\n        structuredMetaKey: this.#options.structuredMetaKey,\n        logFormat: this.#options.logFormat,\n      }),\n    )\n\n    debug(`[LogPusher] pushing ${lokiLogs.length} logs to Loki`)\n\n    try {\n      const response = await fetch(\n        new URL(this.#options.endpoint ?? 'loki/api/v1/push', this.#options.host),\n        {\n          method: 'POST',\n          signal: AbortSignal.timeout(this.#options.timeout ?? 30_000),\n          headers: {\n            ...this.#options.headers,\n            ...(this.#options.basicAuth && {\n              Authorization:\n                'Basic ' +\n                Buffer.from(\n                  `${this.#options.basicAuth.username}:${this.#options.basicAuth.password}`,\n                ).toString('base64'),\n            }),\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ streams: lokiLogs }),\n        },\n      )\n\n      if (!response.ok) {\n        throw new RequestError('Got error when trying to send log to loki', await response.text())\n      }\n    } catch (err) {\n      this.#handleFailure(err)\n    }\n\n    debug(`[LogPusher] pushed ${lokiLogs.length} logs to Loki`, { logs: lokiLogs })\n  }\n}\n","import abstractTransportBuild from 'pino-abstract-transport'\n\nimport debug from './debug.ts'\nimport { LogPusher } from './log_pusher.ts'\nimport { LokiLogLevel } from './constants.ts'\nimport type { PinoLog, LokiOptions, BatchingOptions } from './types.ts'\n\ninterface ResolvedBatching {\n  enabled: boolean\n  interval: number\n  maxBufferSize: number\n}\n\nfunction resolveBatching(batching: LokiOptions['batching']): ResolvedBatching {\n  if (batching === false) return { enabled: false, interval: 5, maxBufferSize: 10_000 }\n\n  return {\n    enabled: true,\n    interval: batching?.interval ?? 5,\n    maxBufferSize: batching?.maxBufferSize ?? 10_000,\n  }\n}\n\n/**\n * Resolves the options for the Pino Loki transport\n */\nfunction resolveOptions(options: LokiOptions) {\n  return {\n    ...options,\n    endpoint: options.endpoint ?? 'loki/api/v1/push',\n    timeout: options.timeout ?? 30_000,\n    silenceErrors: options.silenceErrors ?? false,\n    batching: resolveBatching(options.batching),\n    replaceTimestamp: options.replaceTimestamp ?? false,\n    propsToLabels: options.propsToLabels ?? [],\n    convertArrays: options.convertArrays ?? false,\n    structuredMetaKey:\n      options.structuredMetaKey === false ? undefined : (options.structuredMetaKey ?? 'meta'),\n    logFormat: options.logFormat,\n  }\n}\n\nfunction pinoLoki(userOptions: LokiOptions) {\n  const options = resolveOptions(userOptions)\n  const logPusher = new LogPusher(options)\n\n  const { basicAuth: _, ...safeOptions } = options\n  debug(`[PinoLoki] initialized with options: ${JSON.stringify(safeOptions)}`)\n\n  let batchInterval: NodeJS.Timeout | undefined\n  let pinoLogBuffer: PinoLog[] = []\n  let isClosed = false\n\n  return abstractTransportBuild(\n    async (source) => {\n      if (options.batching.enabled) {\n        batchInterval = setInterval(() => {\n          if (isClosed) return\n\n          debug(`Batch interval reached, sending ${pinoLogBuffer.length} logs to Loki`)\n\n          if (pinoLogBuffer.length === 0) return\n\n          const logsToSend = pinoLogBuffer\n          pinoLogBuffer = []\n          logPusher.push(logsToSend)\n        }, options.batching.interval * 1000)\n      }\n\n      for await (const obj of source) {\n        if (options.batching.enabled) {\n          if (\n            options.batching.maxBufferSize > 0 &&\n            pinoLogBuffer.length >= options.batching.maxBufferSize\n          ) {\n            const dropped = pinoLogBuffer.shift()\n            debug(`[PinoLoki] Buffer full, dropping oldest log: ${JSON.stringify(dropped)}`)\n          }\n          pinoLogBuffer.push(obj)\n          continue\n        }\n\n        logPusher.push(obj)\n      }\n    },\n    {\n      /**\n       * When transport is closed, push remaining logs to Loki\n       * and clear the interval\n       */\n      async close() {\n        if (options.batching.enabled) {\n          isClosed = true\n          clearInterval(batchInterval!)\n\n          if (pinoLogBuffer.length > 0) {\n            await logPusher.push(pinoLogBuffer)\n          }\n        }\n      },\n    },\n  )\n}\n\nexport default pinoLoki\nexport { LokiLogLevel, pinoLoki, type LokiOptions, type PinoLog, type BatchingOptions }\n"],"mappings":";;;;AAEA,oBAAe,SAAS,YAAY;;;;ACDpC,MAAa,eAAe;CAC1B,MAAM;CACN,OAAO;CACP,OAAO;CACP,SAAS;CACT,UAAU;CACX;;;;;;;;ACHD,SAAgB,IACd,OACA,MACA,cACU;CACV,MAAM,WAAW,KAAK,MAAM,UAAU;CACtC,IAAIA,UAAe;AAEnB,MAAK,MAAM,OAAO,UAAU;AAC1B,MAAI,YAAY,KAAM,QAAO;AAC7B,MAAI,YAAY,OAAW,QAAO;EAElC,MAAM,cAAc,IAAI,QAAQ,SAAS,GAAG;AAC5C,MAAI,YAAY,MAAM,KAAK,GAAI;AAE/B,YAAU,QAAQ;;AAGpB,KAAI,YAAY,OAAW,QAAO;AAClC,QAAO;;;;;ACpBT,SAAgB,UAAU,SAAyE;CACjG,MAAM,EAAE,KAAK,cAAc;AAE3B,KAAI,aAAa,OAAO,cAAc,SACpC,QAAO,UAAU,QAAQ,gBAAgB,QAAQ,OAAO,IAAI,KAAK,GAAG,IAAI,GAAG;AAG7E,KAAI,aAAa,OAAO,cAAc,WACpC,QAAO,UAAU,QAAQ,IAAI;AAG/B,OAAM,IAAI,MAAM,8DAA8D,OAAO,UAAU;;;;;ACVjG,MAAM,qBAAqB;;;;AAO3B,IAAa,aAAb,MAAwB;CACtB;CACA;CAEA,YAAY,SAA0B;AACpC,QAAKC,gBAAiB,SAAS,iBAAiB,EAAE;AAClD,QAAKC,WAAY,OAAO,OACtB;GACE,IAAI,aAAa;GACjB,IAAI,aAAa;GACjB,IAAI,aAAa;GACjB,IAAI,aAAa;GACjB,IAAI,aAAa;GACjB,IAAI,aAAa;GAClB,EACD,SAAS,SACV;;;;;;CAOH,gBAAgB,KAAc,kBAAoC;AAChE,MAAI,iBACF,0BAAQ,IAAI,MAAM,EAAC,SAAS,GAAG,KAAW,UAAU;EAGtD,MAAM,OAAO,IAAI,QAAQ,KAAK,KAAK;EACnC,MAAM,UAAU,KAAK,UAAU;AAG/B,MAAI,QAAQ,WAAW,mBACrB,QAAO;AAKT,UAAQ,OADc,OAAO,KAAK,QAAQ,SACZ,UAAU;;;;;;CAO1C,cAAc,KAAc,eAAiC;AAC3D,SAAO,KAAK,UAAU,MAAM,GAAG,UAAU;AACvC,OAAI,CAAC,cAAe,QAAO;AAE3B,OAAI,MAAM,QAAQ,MAAM,CACtB,QAAO,OAAO,YAAY,MAAM,KAAK,SAAO,UAAU,CAAC,OAAOC,QAAM,CAAC,CAAC;AAGxE,UAAO;IACP;;CAGJ,sBAAsB,KAAc;EAClC,MAAMC,SAAiC,EAAE;AAEzC,OAAK,MAAM,QAAQ,MAAKH,cACtB,KAAI,IAAI,MACN,QAAO,QAAQ,IAAI;AAIvB,SAAO;;;;;CAMT,yBACE,KACA,mBACoC;AACpC,MAAI,CAAC,kBAAmB,QAAO;EAE/B,MAAM,OAAO,IAAI;AACjB,MAAI,CAAC,QAAQ,OAAO,SAAS,SAAU,QAAO;EAE9C,MAAMI,SAAiC,EAAE;AACzC,OAAK,MAAM,CAAC,KAAK,UAAU,OAAO,QAAQ,KAAK,CAC7C,KAAI,OAAO,UAAU,SAAU,QAAO,OAAO;WACpC,OAAO,UAAU,YAAY,UAAU,KAAM,QAAO,OAAO,KAAK,UAAU,MAAM;MACpF,QAAO,OAAO,OAAO,MAAM;AAGlC,SAAO;;;;;CAMT,gBAAgB,OAAe;AAC7B,SAAO,MAAKH,SAAU,UAAU,aAAa;;;;;CAM/C,MAAM,SAOM;EACV,MAAM,EAAE,UAAU,GAAG,uBAAuB,QAAQ;EAEpD,MAAM,SAAS,KAAK,gBAAgB,QAAQ,IAAI,MAAM;EACtD,MAAM,OAAO,MAAKI,eAAgB,QAAQ,KAAK,QAAQ,iBAAiB;EACxE,MAAM,cAAc,MAAKC,qBAAsB,QAAQ,IAAI;EAC3D,MAAM,qBAAqB,MAAKC,wBAAyB,QAAQ,KAAK,QAAQ,kBAAkB;EAEhG,MAAM,mBAAmB,QAAQ,YAC7B,UAAU;GACR,WAAW,QAAQ;GACnB,KAAK;IAAE,GAAG;IAAoB,WAAW;IAAQ;GAClD,CAAC,GACF,MAAKC,aAAc,oBAAoB,QAAQ,cAAc;AAEjE,SAAO;GACL,QAAQ;IACN,OAAO;IACP;IACA,GAAG,QAAQ;IACX,GAAG;IACJ;GACD,QAAQ,CAIN,qBACI;IAAC;IAAM;IAAkB;IAAmB,GAC5C,CAAC,MAAM,iBAAiB,CAC7B;GACF;;;;;;ACjJL,IAAM,eAAN,cAA2B,MAAM;CAC/B;CAEA,YAAY,SAAiB,cAAsB;AACjD,QAAM,QAAQ;AACd,OAAK,OAAO;AACZ,OAAK,eAAe;;;;;;AAOxB,IAAa,YAAb,MAAuB;CACrB;CACA;CAEA,YAAY,SAAsB;AAChC,QAAKC,UAAW;AAEhB,QAAKC,aAAc,IAAI,WAAW;GAChC,UAAU,QAAQ;GAClB,eAAe,QAAQ;GACxB,CAAC;;;;;CAMJ,eAAe,KAAU;AACvB,MAAI,MAAKD,QAAS,kBAAkB,KAClC;AAGF,MAAI,eAAe,cAAc;AAC/B,WAAQ,MAAM,IAAI,UAAU,OAAO,IAAI,aAAa;AACpD;;AAGF,UAAQ,MAAM,oEAAoE,IAAI;;;;;CAMxF,MAAM,KAAK,MAA2B;AACpC,MAAI,CAAC,MAAM,QAAQ,KAAK,CACtB,QAAO,CAAC,KAAK;EAGf,MAAM,WAAW,KAAK,KAAK,QACzB,MAAKC,WAAY,MAAM;GACrB;GACA,kBAAkB,MAAKD,QAAS;GAChC,kBAAkB,MAAKA,QAAS;GAChC,eAAe,MAAKA,QAAS;GAC7B,mBAAmB,MAAKA,QAAS;GACjC,WAAW,MAAKA,QAAS;GAC1B,CAAC,CACH;AAED,gBAAM,uBAAuB,SAAS,OAAO,eAAe;AAE5D,MAAI;GACF,MAAM,WAAW,MAAM,MACrB,IAAI,IAAI,MAAKA,QAAS,YAAY,oBAAoB,MAAKA,QAAS,KAAK,EACzE;IACE,QAAQ;IACR,QAAQ,YAAY,QAAQ,MAAKA,QAAS,WAAW,IAAO;IAC5D,SAAS;KACP,GAAG,MAAKA,QAAS;KACjB,GAAI,MAAKA,QAAS,aAAa,EAC7B,eACE,WACA,OAAO,KACL,GAAG,MAAKA,QAAS,UAAU,SAAS,GAAG,MAAKA,QAAS,UAAU,WAChE,CAAC,SAAS,SAAS,EACvB;KACD,gBAAgB;KACjB;IACD,MAAM,KAAK,UAAU,EAAE,SAAS,UAAU,CAAC;IAC5C,CACF;AAED,OAAI,CAAC,SAAS,GACZ,OAAM,IAAI,aAAa,6CAA6C,MAAM,SAAS,MAAM,CAAC;WAErF,KAAK;AACZ,SAAKE,cAAe,IAAI;;AAG1B,gBAAM,sBAAsB,SAAS,OAAO,gBAAgB,EAAE,MAAM,UAAU,CAAC;;;;;;AClFnF,SAAS,gBAAgB,UAAqD;AAC5E,KAAI,aAAa,MAAO,QAAO;EAAE,SAAS;EAAO,UAAU;EAAG,eAAe;EAAQ;AAErF,QAAO;EACL,SAAS;EACT,UAAU,UAAU,YAAY;EAChC,eAAe,UAAU,iBAAiB;EAC3C;;;;;AAMH,SAAS,eAAe,SAAsB;AAC5C,QAAO;EACL,GAAG;EACH,UAAU,QAAQ,YAAY;EAC9B,SAAS,QAAQ,WAAW;EAC5B,eAAe,QAAQ,iBAAiB;EACxC,UAAU,gBAAgB,QAAQ,SAAS;EAC3C,kBAAkB,QAAQ,oBAAoB;EAC9C,eAAe,QAAQ,iBAAiB,EAAE;EAC1C,eAAe,QAAQ,iBAAiB;EACxC,mBACE,QAAQ,sBAAsB,QAAQ,SAAa,QAAQ,qBAAqB;EAClF,WAAW,QAAQ;EACpB;;AAGH,SAAS,SAAS,aAA0B;CAC1C,MAAM,UAAU,eAAe,YAAY;CAC3C,MAAM,YAAY,IAAI,UAAU,QAAQ;CAExC,MAAM,EAAE,WAAW,GAAG,GAAG,gBAAgB;AACzC,eAAM,wCAAwC,KAAK,UAAU,YAAY,GAAG;CAE5E,IAAIC;CACJ,IAAIC,gBAA2B,EAAE;CACjC,IAAI,WAAW;AAEf,QAAO,uBACL,OAAO,WAAW;AAChB,MAAI,QAAQ,SAAS,QACnB,iBAAgB,kBAAkB;AAChC,OAAI,SAAU;AAEd,iBAAM,mCAAmC,cAAc,OAAO,eAAe;AAE7E,OAAI,cAAc,WAAW,EAAG;GAEhC,MAAM,aAAa;AACnB,mBAAgB,EAAE;AAClB,aAAU,KAAK,WAAW;KACzB,QAAQ,SAAS,WAAW,IAAK;AAGtC,aAAW,MAAM,OAAO,QAAQ;AAC9B,OAAI,QAAQ,SAAS,SAAS;AAC5B,QACE,QAAQ,SAAS,gBAAgB,KACjC,cAAc,UAAU,QAAQ,SAAS,eACzC;KACA,MAAM,UAAU,cAAc,OAAO;AACrC,mBAAM,gDAAgD,KAAK,UAAU,QAAQ,GAAG;;AAElF,kBAAc,KAAK,IAAI;AACvB;;AAGF,aAAU,KAAK,IAAI;;IAGvB,EAKE,MAAM,QAAQ;AACZ,MAAI,QAAQ,SAAS,SAAS;AAC5B,cAAW;AACX,iBAAc,cAAe;AAE7B,OAAI,cAAc,SAAS,EACzB,OAAM,UAAU,KAAK,cAAc;;IAI1C,CACF;;AAGH,kBAAe"}